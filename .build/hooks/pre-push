#!/bin/bash
#
# Pre-push hook: Validate plugin files + Auto documentation updates
#
# Triggers:
#   - git push origin dev    ‚Üí Validate + Update README.md
#   - git push origin master ‚Üí Validate + Schedule Wiki update
#

REPO_ROOT="$(git rev-parse --show-toplevel)"
HOOKS_DIR="$REPO_ROOT/.build/hooks"

echo ""
echo "========================================"
echo "  Pre-Push Validation"
echo "========================================"
echo ""

# Step 1: Run validation script
bash "$REPO_ROOT/.build/validate-tracked-files.sh"

VALIDATION_RESULT=$?

if [ $VALIDATION_RESULT -ne 0 ]; then
    echo ""
    echo "‚ùå PUSH BLOCKED!"
    echo ""
    echo "Development files detected in Git tracking."
    echo "Only plugin files should be pushed to GitHub."
    echo ""
    echo "Fix the issues above before pushing."
    echo ""
    echo "To bypass this check (NOT recommended):"
    echo "  git push --no-verify"
    echo ""
    exit 1
fi

echo ""
echo "‚úì Validation passed. Proceeding with push..."
echo ""

# Step 2: Run documentation update hook
DOC_HOOK="$HOOKS_DIR/pre-push.py"

if [ -f "$DOC_HOOK" ]; then
    python "$DOC_HOOK" "$@"
    DOC_RESULT=$?
    
    if [ $DOC_RESULT -ne 0 ]; then
        echo ""
        echo "‚ö†Ô∏è  Documentation update failed, but push will continue"
        echo "    Please manually update documentation later"
        echo ""
    fi
else
    echo "‚ö†Ô∏è  Documentation hook not found: $DOC_HOOK"
    echo "    Skipping documentation update"
fi

WIKI_PROCESSOR="$HOOKS_DIR/process-wiki-update.py"
PENDING_FILE="$REPO_ROOT/.build/.wiki-update-pending"

if [ -f "$PENDING_FILE" ] && [ -f "$WIKI_PROCESSOR" ]; then
    echo ""
    echo "üìö Running wiki update in background after push..."
    (sleep 5 && python "$WIKI_PROCESSOR") &
    echo "   Wiki will be updated in ~5 seconds"
fi

exit 0
